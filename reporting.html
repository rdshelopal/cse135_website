<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Reporting Dashboard</title>
  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
  <style>
    html, body { margin:0; padding:0; font-family: sans-serif; }
    h2 { text-align:center; margin: 1em 0 0.5em; }
    .chart-container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto 2em;
      height: 400px;
    }
  </style>
</head>
<body>
  <h2>User Agents</h2>
  <div id="ua-pie" class="chart-container"></div>

  <h2>Languages</h2>
  <div id="lang-pie" class="chart-container"></div>

  <h2>JavaScript Enabled</h2>
  <div id="js-pie" class="chart-container"></div>

  <script>
    (async function () {
      const resp = await fetch('https://rshelopal.site/api/static');
      if (!resp.ok) throw new Error('Failed to load /api/static');
      const rows = await resp.json();

      // Utility to build a pie config from counts
      function makePieConfig(title, counts) {
        const total = Array.from(counts.values()).reduce((a,b) => a+b, 0) || 1;
        const series = Array.from(counts.entries()).map(([label, value]) => ({
          text: label,
          values: [value],
          tooltip: { text: `%t: %v (${((value/total)*100).toFixed(1)}%)` }
        }));
        return {
          type: 'pie',
          title: { text: title },
          legend: { draggable:true },
          plot: {
            valueBox: { text: '%npv%', placement: 'out', fontSize:'10px' }
          },
          series
        };
      }

      // 1) User Agent
      const uaCounts = new Map();
      for (const r of rows) {
        const ua = (r.user_agent && String(r.user_agent).trim()) || 'Unknown';
        uaCounts.set(ua, (uaCounts.get(ua) || 0) + 1);
      }
      zingchart.render({ id:'ua-pie', data: makePieConfig('User Agents', uaCounts), height:'100%', width:'100%' });

      // 2) Language
      const langCounts = new Map();
      for (const r of rows) {
        const lang = (r.language && String(r.language).trim()) || 'Unknown';
        langCounts.set(lang, (langCounts.get(lang) || 0) + 1);
      }
      zingchart.render({ id:'lang-pie', data: makePieConfig('Languages', langCounts), height:'100%', width:'100%' });

      // 3) JS Enabled
      const jsCounts = new Map([['Enabled',0],['Disabled',0],['Unknown',0]]);
      for (const r of rows) {
        if (r.javascript_enabled === 1) jsCounts.set('Enabled', jsCounts.get('Enabled')+1);
        else if (r.javascript_enabled === 0) jsCounts.set('Disabled', jsCounts.get('Disabled')+1);
        else jsCounts.set('Unknown', jsCounts.get('Unknown')+1);
      }
      zingchart.render({ id:'js-pie', data: makePieConfig('JavaScript Enabled', jsCounts), height:'100%', width:'100%' });

    })().catch(err => {
      console.error(err);
      document.body.innerHTML = '<p style="color:red;text-align:center">Failed to load reporting data.</p>';
    });
  </script>
</body>
</html>
