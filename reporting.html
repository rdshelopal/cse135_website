<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>User Agents Pie</title>
  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
  <style>
    html, body { height:100%; margin:0; }
    #ua-pie { height: 520px; width: 100%; }
  </style>
</head>
<body>
  <div id="ua-pie"></div>

  <script>
    (async function () {
      // 1) Get all rows from your existing endpoint
      const resp = await fetch('/api/static');
      if (!resp.ok) throw new Error('Failed to load /api/static');
      const rows = await resp.json();

      // 2) Group by user_agent (exact string). Null/empty -> "Unknown"
      const counts = new Map();
      for (const r of rows) {
        const ua = (r.user_agent && String(r.user_agent).trim()) || 'Unknown';
        counts.set(ua, (counts.get(ua) || 0) + 1);
      }

      // Optional: keep chart readable by showing top N & grouping the rest
      const TOP_N = 10; // change or remove this block to show every UA
      const sorted = Array.from(counts.entries()).sort((a,b) => b[1] - a[1]);
      const top = sorted.slice(0, TOP_N);
      const restCount = sorted.slice(TOP_N).reduce((s, [,v]) => s + v, 0);
      if (restCount > 0) top.push(['Other', restCount]);

      const total = rows.length || 1;

      // 3) Build ZingChart series
      const series = top.map(([label, value]) => ({
        text: label,
        values: [value],
        // Tooltip shows count and percentage
        tooltip: { text: `%t: %v (${((value/total)*100).toFixed(1)}%)` }
      }));

      // 4) Render the pie
      const config = {
        type: 'pie',
        title: { text: 'User Agents (proportion of traffic)' },
        legend: {
          draggable: true,
          align: 'right',
          verticalAlign: 'middle',
          layout: 'vertical',
          borderWidth: '0'
        },
        plot: {
          slice: 60,
          valueBox: {
            // show percentages on slices
            text: '%npv%',
            placement: 'out',
            fontSize: '10px'
          }
        },
        series
      };

      zingchart.render({
        id: 'ua-pie',
        data: config,
        height: '520px',
        width: '100%'
      });
    })().catch(err => {
      console.error(err);
      document.getElementById('ua-pie').textContent =
        'Failed to load data for chart.';
    });
  </script>
</body>
</html>