<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Reporting Dashboard</title>
  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
  <style>
    :root { --maxw: 1100px; }
    body { margin:0; font-family: system-ui, sans-serif; background:#fafafa; }
    header { text-align:center; padding:18px 12px; }
    main { max-width: var(--maxw); margin: 0 auto; padding: 0 12px 40px; }
    h2 { margin: 22px 0 8px; font-size: 20px; }
    .chart { height: 420px; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:8px; }
    .grid-wrap { background:#fff; border:1px solid #e8e8e8; border-radius:12px; overflow:auto; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #f0f0f0; text-align:left; }
    th { background:#f9f9f9; position: sticky; top:0; }
    tfoot td { font-weight:600; }
    .muted { color:#666; font-size: 13px; }
  </style>
</head>
<body>
  <header>
    <h1>Reporting</h1>
    <div class="muted">Data source: <code>/api/static</code></div>
  </header>
  <main>
    <h2>User Agents (Pie)</h2>
    <div id="ua-pie" class="chart"></div>

    <h2>Screen Width (Bar)</h2>
    <div id="sw-bar" class="chart"></div>

    <h2>Languages (Grid)</h2>
    <div class="grid-wrap">
      <table id="lang-grid">
        <thead>
          <tr><th>Language</th><th>Count</th><th>Percent</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>Total</td><td id="lang-total">0</td><td>100%</td></tr>
        </tfoot>
      </table>
    </div>
  </main>

  <script>
    (async function () {
      const resp = await fetch('https://rshelopal.site/api/static');
      if (!resp.ok) throw new Error('Failed to load /api/static');
      const rows = await resp.json();
      const total = rows.length || 1;

      // ---------- helpers ----------
      const inc = (map, key) => map.set(key, (map.get(key) || 0) + 1);
      const toSeriesPie = (counts) => {
        const sum = Array.from(counts.values()).reduce((a,b)=>a+b, 0) || 1;
        return Array.from(counts.entries()).map(([label, value]) => ({
          text: label,
          values: [value],
          tooltip: { text: `%t: %v (${((value/sum)*100).toFixed(1)}%)` }
        }));
      };

      // ---------- 1) User Agent Pie ----------
      const uaCounts = new Map();
      for (const r of rows) {
        const ua = (r.user_agent && String(r.user_agent).trim()) || 'Unknown';
        inc(uaCounts, ua);
      }
      zingchart.render({
        id: 'ua-pie',
        data: {
          type: 'pie',
          title: { text: 'User Agents' },
          legend: { draggable: true },
          plot: { valueBox: { text: '%npv%', placement: 'out', fontSize: '10px' } },
          series: toSeriesPie(uaCounts)
        },
        height: '100%', width: '100%'
      });

      // ---------- 2) Screen Width Bar ----------
      const swCounts = new Map();
      for (const r of rows) {
        const w = (typeof r.screen_width === 'number' && isFinite(r.screen_width))
          ? r.screen_width : 'Unknown';
        inc(swCounts, String(w));
      }
      // Sort numerically where possible, with "Unknown" last
      const swEntries = Array.from(swCounts.entries()).sort((a, b) => {
        const an = Number(a[0]), bn = Number(b[0]);
        const aIsNum = Number.isFinite(an), bIsNum = Number.isFinite(bn);
        if (aIsNum && bIsNum) return an - bn;
        if (aIsNum) return -1;
        if (bIsNum) return 1;
        return String(a[0]).localeCompare(String(b[0]));
      });
      const swLabels = swEntries.map(([k]) => k);
      const swValues = swEntries.map(([,v]) => v);

      zingchart.render({
        id: 'sw-bar',
        data: {
          type: 'bar',
          title: { text: 'Screen Width (pixels)' },
          scaleX: { labels: swLabels, label: { text: 'Width (px)' }, item: { fontSize: 10 } },
          scaleY: { label: { text: 'Count' }, guide: { lineStyle: 'dotted' } },
          plot: { tooltip: { text: 'Width %kt: %v' } },
          series: [{ values: swValues }]
        },
        height: '100%', width: '100%'
      });

      // ---------- 3) Languages Grid ----------
      const langCounts = new Map();
      for (const r of rows) {
        const lang = (r.language && String(r.language).trim()) || 'Unknown';
        inc(langCounts, lang);
      }
      const tbody = document.querySelector('#lang-grid tbody');
      const totalCell = document.getElementById('lang-total');
      const sortedLangs = Array.from(langCounts.entries()).sort((a,b)=> b[1]-a[1]);

      let runningTotal = 0;
      for (const [lang, count] of sortedLangs) {
        runningTotal += count;
        const tr = document.createElement('tr');
        const pct = ((count / total) * 100).toFixed(1) + '%';
        tr.innerHTML = `<td>${lang}</td><td>${count}</td><td>${pct}</td>`;
        tbody.appendChild(tr);
      }
      totalCell.textContent = String(runningTotal);
    })().catch(err => {
      console.error(err);
      document.body.innerHTML = '<p style="color:red;text-align:center;margin-top:20px">Failed to load reporting data.</p>';
    });
  </script>
</body>
</html>
